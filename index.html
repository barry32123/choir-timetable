<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choir Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f9f9f9; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    pre { background: #fff; padding: 1rem; border: 1px solid #ccc; white-space: pre-wrap; }
    .log-entry { margin-bottom: 0.5rem; font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
  <h1>St. Mary's Choir Timetable Generator</h1>
  <button onclick="generateTimetable()">Generate Timetable</button>
  <button onclick="copyText()">Copy Output</button>
  <h2>Weekly Timetable</h2>
  <pre id="output"></pre>
  <h2>Generation Log</h2>
  <div id="log"></div>

  <script>
    const maleSingers = ["seby", "sebastian", "roy", "phijo", "shaji", "robert", "don", "aibel", "atul"];
    const femaleSingers = ["anu", "angel", "jemcy", "sini", "priya", "dona", "soyal", "jincy", "biji", "christy", "sneha"];
    const keyboardists = ["abraham sn", "abraham jr", "davis", "sebastian", "shaji"];
    const hybridKeyboardists = ["sebastian", "shaji"];
    const prioritizedKeyboardists = ["davis", "abraham sn", "abraham jr"];

    const unavailableFriday10am = ["atul", "aibel", "angel", "sneha", "soyal", "christy", "dona", "abraham jr", "abraham sn", "jemcy"];
    const abrahamSnUnavailable = ["friday-10:00", "friday-17:30"];
    const morningOnly = ["seby", "jincy", "biji"];

    const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
    const massSchedule = {
      monday:    ["5:30", "7:00"],
      tuesday:   ["5:30", "7:00"],
      wednesday: ["5:30", "7:00"],
      thursday:  ["5:30", "7:00"],
      friday:    ["5:30", "7:00", "10:00", "17:30"],
      saturday:  ["5:30", "7:00"],
      sunday:    ["5:30", "7:00", "10:00", "17:00"]
    };

    const keyboardMasses = {
      friday: ["7:00", "10:00", "17:30"],
      saturday: ["7:00"],
      sunday: ["7:00", "10:00", "17:00"]
    };

    const hybridLimit = { sebastian: 0, shaji: 0 };

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function chooseSingers(time, day) {
      let males = [...maleSingers];
      let females = [...femaleSingers];

      shuffle(males);
      shuffle(females);

      let ratio;
      if (time === "5:30") {
        // Increase chance for morningOnly members
        const poolM = males.filter(m => morningOnly.includes(m));
        const poolF = females.filter(f => morningOnly.includes(f));
        const rand = Math.random();

        if (rand < 0.6 && poolM.length > 0 && poolF.length > 0) {
          return [poolM[0], poolF[0]];
        }
        ratio = [1, 1];
      } else if ((day === "friday" && time === "7:00") || (day === "sunday" && time === "7:00")) {
        ratio = [2, 2];
      } else {
        ratio = [[1, 1], [1, 2], [2, 2]][Math.floor(Math.random() * 3)];
      }

      const selectedM = males.slice(0, ratio[0]);
      const selectedF = females.slice(0, ratio[1]);
      return [...selectedM, ...selectedF];
    }

    function chooseKeyboardist(day, time) {
      const available = keyboardists.filter(k => !(k === "abraham sn" && abrahamSnUnavailable.includes(`${day}-${time}`)));
      const priority = prioritizedKeyboardists.filter(k => available.includes(k));

      if (priority.length > 0) return priority[Math.floor(Math.random() * priority.length)];

      const hybrids = hybridKeyboardists.filter(h => hybridLimit[h] < 1 && available.includes(h));
      if (hybrids.length > 0) {
        const chosen = hybrids[Math.floor(Math.random() * hybrids.length)];
        hybridLimit[chosen]++;
        return chosen;
      }

      return available[Math.floor(Math.random() * available.length)] || "";
    }

    function generateTimetable() {
      hybridLimit.sebastian = 0;
      hybridLimit.shaji = 0;

      const timetable = [];

      for (const day of days) {
        timetable.push(day.toUpperCase());
        for (const time of massSchedule[day]) {
          const massId = `${day}-${time}`;

          // Apply exception filter for Friday 10AM
          let singers = chooseSingers(time, day);
          if (day === "friday" && time === "10:00") {
            singers = singers.filter(p => !unavailableFriday10am.includes(p));
          }

          let keyboard = "";
          if (keyboardMasses[day]?.includes(time)) {
            keyboard = chooseKeyboardist(day, time);

            // if hybrid and not already in singers, optionally add to singers
            if (hybridKeyboardists.includes(keyboard) && !singers.includes(keyboard) && Math.random() < 0.5) {
              singers.push(keyboard);
            }
          }

          timetable.push(`${time} - Singers: ${singers.join(", ")} | Keyboard: ${keyboard}`);
        }
        timetable.push("\n");
      }

      const out = timetable.join("\n");
      document.getElementById("output").innerText = out;
      logGeneration();
    }

    function copyText() {
      const text = document.getElementById("output").innerText;
      navigator.clipboard.writeText(text).then(() => alert("Timetable copied!"));
    }

    function logGeneration() {
      const log = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.textContent = `Generated on: ${new Date().toLocaleString()}`;
      log.prepend(entry);
    }
  </script>
</body>
</html>
