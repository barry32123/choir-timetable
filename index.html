<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choir Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    button { margin: 0.5rem 0; }
    pre { background: #f4f4f4; padding: 1rem; white-space: pre-wrap; word-wrap: break-word; }
    textarea { width: 100%; height: 150px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Choir Timetable Generator</h1>
  <button onclick="generateTimetable()">Generate Timetable</button>
  <button onclick="copyTimetable()">Copy Timetable</button>
  <button onclick="downloadCSV()">Download CSV</button>
  <pre id="output"></pre>
  <h2>Member Availability (JSON Format)</h2>
  <textarea id="availabilityInput" placeholder="Paste availability JSON here or leave empty for default."></textarea>

  <script>
    const singers = {
      male: ["Seby", "Sebastian", "Roy", "Phijo", "Shaji", "Robert", "Don", "Aibel", "Atul"],
      female: ["Anu", "Angel", "Jemcy", "Sini", "Priya", "Dona", "Soyal", "Jincy", "Biji", "Christy", "Sneha"]
    };

    const keyboardists = ["Abraham Sn", "Abraham Jr.", "Davis", "Sebastian", "Shaji"];
    const hybrid = ["Sebastian", "Shaji"];

    let history = JSON.parse(localStorage.getItem("choirHistory") || "{}");
    let hybridHistory = JSON.parse(localStorage.getItem("hybridRotation") || "{}");

    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const masses = ["5:30 AM", "10:00 AM", "5:30 PM"];

    const fixedAssignments = {
      "Friday": {
        "10:00 AM": { exclude: ["Abraham Sn"] },
        "5:30 PM": { exclude: ["Abraham Sn"] }
      }
    };

    const earlyMassQuota = {
      "Seby": 0, "Jincy": 0, "Biji": 0
    };

    function shuffle(array) {
      let a = [...array];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function isValidCombination(m, f) {
      return (m === 1 && f >= 1) || (m === 2 && f === 2);
    }

    function getAvailable(name, day, mass, availability) {
      return !availability[name] || availability[name][day]?.includes(mass);
    }

    function selectHybrid(day) {
      const lastUsed = hybridHistory[day];
      const selected = lastUsed === hybrid[0] ? hybrid[1] : hybrid[0];
      hybridHistory[day] = selected;
      return selected;
    }

    function generateTimetable() {
      const output = [];
      const used = { male: {}, female: {}, keyboard: {} };
      let availability;
      try {
        availability = JSON.parse(document.getElementById("availabilityInput").value || "{}");
      } catch (e) {
        alert("Invalid JSON in availability input");
        return;
      }

      days.forEach(day => {
        output.push(day);
        masses.forEach(mass => {
          let requiredMale = 1, requiredFemale = 1;
          if (mass !== "5:30 AM") requiredFemale++;
          if (mass !== "5:30 AM") requiredMale = 2;

          let valid = false, combo;
          const fm = shuffle(singers.male.filter(n => getAvailable(n, day, mass, availability)));
          const ff = shuffle(singers.female.filter(n => getAvailable(n, day, mass, availability)));

          const maxTry = 30;
          for (let i = 0; i < maxTry; i++) {
            const m = shuffle(fm).slice(0, requiredMale);
            const f = shuffle(ff).slice(0, requiredFemale);
            if (isValidCombination(m.length, f.length)) {
              combo = { male: m, female: f };
              valid = true;
              break;
            }
          }

          if (!valid) {
            output.push(` ${mass}: Not enough singers.`);
            return;
          }

          combo.male.forEach(name => used.male[name] = (used.male[name] || 0) + 1);
          combo.female.forEach(name => used.female[name] = (used.female[name] || 0) + 1);

          if (mass === "5:30 AM") {
            [...combo.male, ...combo.female].forEach(name => {
              if (earlyMassQuota[name] !== undefined) earlyMassQuota[name]++;
            });
          }

          const kbOptions = shuffle(keyboardists.filter(k => getAvailable(k, day, mass, availability)));
          const massException = fixedAssignments[day]?.[mass]?.exclude || [];
          const filteredKB = kbOptions.filter(k => !massException.includes(k));

          let kb = filteredKB.find(k => !hybrid.includes(k)) || selectHybrid(day);
          used.keyboard[kb] = (used.keyboard[kb] || 0) + 1;

          output.push(` ${mass}: ${combo.male.join(", ")} | ${combo.female.join(", ")} | Keyboard: ${kb}`);
        });
        output.push("");
      });

      localStorage.setItem("choirHistory", JSON.stringify(used));
      localStorage.setItem("hybridRotation", JSON.stringify(hybridHistory));
      document.getElementById("output").textContent = output.join("\n");
    }

    function copyTimetable() {
      const text = document.getElementById("output").textContent;
      navigator.clipboard.writeText(text).then(() => alert("Timetable copied!"));
    }

    function downloadCSV() {
      const text = document.getElementById("output").textContent;
      const blob = new Blob([text], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "choir_timetable.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
