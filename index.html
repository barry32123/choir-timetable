<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Choir Timetable Generator - St. Mary's Forane Church</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f5f7fa; }
    h1, h2 { text-align: center; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .mass-entry { background: #fff; border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .log-box { background: #eef; padding: 10px; margin-top: 30px; border-radius: 8px; }
    pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; }
  </style>
</head>
<body>

<h1>St. Mary's Choir Timetable Generator</h1>
<div style="text-align:center;">
  <button onclick="generateTimetable()">ðŸŽµ Generate Timetable</button>
  <button onclick="copyTimetable()">ðŸ“‹ Copy Timetable</button>
</div>

<h2>This Week's Timetable</h2>
<div id="timetable"></div>

<div class="log-box">
  <h2>ðŸ“– Assignment Log (View-Only)</h2>
  <pre id="logDisplay"></pre>
</div>

<script>
// === Member Definitions ===
const members = {
  maleSingers: [
    { name: "seby", earlyOnly: true },
    { name: "sebastian" },
    { name: "roy" },
    { name: "phijo" },
    { name: "shaji" },
    { name: "robert" },
    { name: "don" },
    { name: "aibel", friday10amUnavailable: true },
    { name: "ajone", friday10amUnavailable: true },
    { name: "atul", friday10amUnavailable: true },
  ],
  femaleSingers: [
    { name: "anu" },
    { name: "angel", friday10amUnavailable: true },
    { name: "jemcy", friday10amUnavailable: true },
    { name: "sini" },
    { name: "priya" },
    { name: "dona", friday10amUnavailable: true },
    { name: "soyal", friday10amUnavailable: true },
    { name: "jincy", earlyOnly: true },
    { name: "biji", earlyOnly: true },
    { name: "christy", friday10amUnavailable: true },
    { name: "sneha", friday10amUnavailable: true },
  ],
  keyboardists: [
    { name: "abraham sn", friday10amUnavailable: true },
    { name: "abraham jr", friday10amUnavailable: true },
    { name: "davis" },
    { name: "sebastian", hybrid: true },
    { name: "shaji", hybrid: true },
  ],
};

const weeklyMasses = {
  "Monday": ["5:30am", "7am"],
  "Tuesday": ["5:30am", "7am"],
  "Wednesday": ["5:30am", "7am"],
  "Thursday": ["5:30am", "7am"],
  "Friday": ["5:30am", "7am", "10am", "5:30pm"],
  "Saturday": ["5:30am", "7am"],
  "Sunday": ["5:30am", "7am", "10am", "5pm"],
};

const massesWithKeyboard = {
  "Friday": ["7am", "10am", "5:30pm"],
  "Saturday": ["7am"],
  "Sunday": ["7am", "10am", "5pm"]
};

const usedToday = {};
const usageCounter = {};
const assignmentLog = [];

function isAvailable(member, day, time) {
  if (member.earlyOnly && time !== "5:30am") return false;
  if (member.friday10amUnavailable && day === "Friday" && time === "10am") return false;
  return true;
}

function getEligibleMembers(list, day, time) {
  return list.filter(m => isAvailable(m, day, time));
}

function markUsed(member, day) {
  if (!usedToday[day]) usedToday[day] = new Set();
  usedToday[day].add(member.name);
  usageCounter[member.name] = (usageCounter[member.name] || 0) + 1;
}

function hasBeenUsedToday(member, day) {
  return usedToday[day] && usedToday[day].has(member.name);
}

function pickRandomMembers(candidates, count, day) {
  const fresh = candidates.filter(m => !hasBeenUsedToday(m, day));
  const stale = candidates.filter(m => hasBeenUsedToday(m, day));
  const shuffled = fresh.concat(stale).sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

function assignChoir(day, time) {
  const malePool = getEligibleMembers(members.maleSingers, day, time);
  const femalePool = getEligibleMembers(members.femaleSingers, day, time);

  let config = { males: 1, females: 1 };
  if (time === "5:30am") config = { males: 1, females: 1 };
  else if ((day === "Friday" && ["7am", "5:30pm"].includes(time)) || (day === "Sunday" && time === "7am")) config = { males: 2, females: 2 };
  else config = Math.random() < 0.5 ? { males: 1, females: 2 } : { males: 1, females: 1 };

  const selectedMales = pickRandomMembers(malePool, config.males, day);
  const selectedFemales = pickRandomMembers(femalePool, config.females, day);
  [...selectedMales, ...selectedFemales].forEach(m => markUsed(m, day));

  let keyboardist = "â€”";
  if (massesWithKeyboard[day]?.includes(time)) {
    const availableKeys = members.keyboardists.filter(k => isAvailable(k, day, time));
    const sortedKeys = availableKeys.sort((a, b) => (usageCounter[a.name] || 0) - (usageCounter[b.name] || 0));
    if (sortedKeys.length > 0) {
      keyboardist = sortedKeys[0].name;
      markUsed(sortedKeys[0], day);
    }
  }

  return {
    day, time,
    singers: [...selectedMales, ...selectedFemales].map(m => m.name),
    keyboard: keyboardist
  };
}

function generateTimetable() {
  assignmentLog.length = 0;
  Object.keys(usedToday).forEach(day => delete usedToday[day]);
  Object.keys(usageCounter).forEach(name => usageCounter[name] = 0);

  for (const [day, times] of Object.entries(weeklyMasses)) {
    for (const time of times) {
      assignmentLog.push(assignChoir(day, time));
    }
  }

  displayTimetable();
  displayLog();
}

function displayTimetable() {
  const div = document.getElementById("timetable");
  div.innerHTML = assignmentLog.map(entry => `
    <div class="mass-entry">
      <strong>${entry.day} ${entry.time}</strong><br>
      ðŸŽ¤ Singers: ${entry.singers.join(", ")}<br>
      ðŸŽ¹ Keyboard: ${entry.keyboard}
    </div>
  `).join("\n");
}

function displayLog() {
  const logText = assignmentLog.map(e => `${e.day} ${e.time}: ${e.singers.join(", ")} | Keyboard: ${e.keyboard}`).join("\n");
  document.getElementById("logDisplay").textContent = logText;
}

function copyTimetable() {
  const text = assignmentLog.map(e => `${e.day} ${e.time}: ${e.singers.join(", ")} | Keyboard: ${e.keyboard}`).join("\n");
  navigator.clipboard.writeText(text).then(() => alert("Timetable copied to clipboard!"));
}
</script>

</body>
</html>
