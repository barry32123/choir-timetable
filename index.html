<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choir Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
    h1 { color: #2c3e50; }
    button { margin: 10px 0; padding: 10px 20px; background-color: #2980b9; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #3498db; }
    pre { background: #ecf0f1; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
    .log { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>St. Maryâ€™s Forane Church Choir Timetable Generator</h1>
  <button onclick="generateTimetable()">Generate Timetable</button>
  <button onclick="copyToClipboard()">Copy to Clipboard</button>
  <pre id="output"></pre>
  <div class="log">
    <h3>Generation Log:</h3>
    <ul id="log"></ul>
  </div>

<script>
const massSchedule = {
  Monday:    ["5:30am", "7am"],
  Tuesday:   ["5:30am", "7am"],
  Wednesday: ["5:30am", "7am"],
  Thursday:  ["5:30am", "7am"],
  Friday:    ["5:30am", "7am", "10am", "5:30pm"],
  Saturday:  ["5:30am", "7am"],
  Sunday:    ["5:30am", "7am", "10am", "5pm"]
};

const keyboardMasses = {
  Friday: ["7am", "10am", "5:30pm"],
  Saturday: ["7am"],
  Sunday: ["7am", "10am", "5pm"]
};

const maleSingers = ["seby", "sebastian", "roy", "phijo", "shaji", "robert", "don", "aibel", "atul"];
const femaleSingers = ["anu", "angel", "jemcy", "sini", "priya", "dona", "soyal", "jincy", "biji", "christy", "sneha"];

const keyboardists = ["abraham sn", "abraham jr", "davis"];
const hybrids = ["sebastian", "shaji"];

const allSingers = [...maleSingers, ...femaleSingers];
const restricted10amFriday = ["atul", "aibel", "angel", "sneha", "soyal", "christy", "dona", "abraham jr", "abraham sn", "jemcy"];

let assignmentHistory = {};
let hybridWeeklyUse = {"sebastian": 0, "shaji": 0};

function shuffle(arr) {
  let a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function chooseSingers(day, time) {
  let males = shuffle(maleSingers);
  let females = shuffle(femaleSingers);
  
  // Bias: 50-60% chance for seby, jincy, biji in 5:30am
  if (time === "5:30am") {
    if (Math.random() < 0.6 && males.includes("seby")) {
      males = ["seby", ...males.filter(m => m !== "seby")];
    }
    if (Math.random() < 0.6 && females.includes("jincy")) {
      females = ["jincy", ...females.filter(f => f !== "jincy")];
    }
    if (Math.random() < 0.6 && females.includes("biji")) {
      females = ["biji", ...females.filter(f => f !== "biji")];
    }
  }

  let ratio;
  if (time === "5:30am") {
    ratio = { m: 1, f: 1 };
  } else {
    ratio = { m: 2, f: 2 }; // default to max ratio
  }

  const male = males.slice(0, ratio.m);
  const female = females.slice(0, ratio.f);
  return [...male, ...female];
}

function chooseKeyboardist(day, time) {
  if (!keyboardMasses[day] || !keyboardMasses[day].includes(time)) return null;

  const preferred = shuffle(["abraham sn", "abraham jr", "davis"]);
  for (let p of preferred) {
    if (!Object.values(assignmentHistory).flat().includes(p)) return p;
  }

  const eligibleHybrids = hybrids.filter(h => hybridWeeklyUse[h] < 1);
  for (let h of shuffle(eligibleHybrids)) {
    hybridWeeklyUse[h]++;
    return h;
  }

  return null;
}

function assignMass(day, time) {
  const singers = chooseSingers(day, time);
  const keyboard = chooseKeyboardist(day, time);

  let result = `${time} - Singers: ${singers.join(", ")}`;
  if (keyboard) {
    if (!singers.includes(keyboard)) result += ` | Keyboard: ${keyboard}`;
    else result += ` | Keyboard/Singer: ${keyboard}`;
  }
  return result;
}

function generateTimetable() {
  assignmentHistory = {};
  hybridWeeklyUse = {"sebastian": 0, "shaji": 0};
  let output = "";
  for (let day of Object.keys(massSchedule)) {
    output += `\n${day.toUpperCase()}:\n`;
    assignmentHistory[day] = [];
    for (let time of massSchedule[day]) {
      // Skip 2m1f (invalid)
      const singers = chooseSingers(day, time);
      if (singers.filter(m => maleSingers.includes(m)).length === 2 && singers.filter(f => femaleSingers.includes(f)).length === 1) continue;

      // Enforce 2m2f for Fri/Sun 7am
      if ((day === "Friday" && time === "7am") || (day === "Sunday" && time === "7am")) {
        if (singers.filter(m => maleSingers.includes(m)).length !== 2 || singers.filter(f => femaleSingers.includes(f)).length !== 2) continue;
      }

      // Skip restricted for Fri 10am
      if (day === "Friday" && time === "10am" && singers.some(s => restricted10amFriday.includes(s))) continue;

      const line = assignMass(day, time);
      assignmentHistory[day].push(line);
      output += line + "\n";
    }
  }

  document.getElementById("output").textContent = output;
  const now = new Date();
  const logEntry = document.createElement("li");
  logEntry.textContent = `Generated at ${now.toLocaleString()}`;
  document.getElementById("log").prepend(logEntry);
}

function copyToClipboard() {
  const text = document.getElementById("output").textContent;
  navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
}
</script>

</body>
</html>
