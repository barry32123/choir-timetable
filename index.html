<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Choir Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    textarea { width: 100%; height: 300px; margin-top: 10px; }
    button { padding: 10px 15px; margin: 10px 0; }
    .log-entry { font-size: 0.9em; color: #555; border-top: 1px solid #ccc; padding: 5px 0; }
  </style>
</head>
<body>
  <h1>St. Mary's Choir Timetable Generator</h1>
  <button onclick="generateTimetable()">Generate Timetable</button>
  <button onclick="copyOutput()">Copy Output</button>
  <textarea id="output" readonly></textarea>
  <h2>Generation Log</h2>
  <div id="log"></div>

  <script>
    const maleSingers = ["seby", "sebastian", "roy", "phijo", "shaji", "robert", "don", "aibel", "atul"];
    const femaleSingers = ["anu", "angel", "jemcy", "sini", "priya", "dona", "soyal", "jincy", "biji", "christy", "sneha"];
    const keyboardists = ["abraham sn", "abraham jr", "davis"];
    const hybridKeyboardists = ["sebastian", "shaji"];
    const allKeyboardists = [...keyboardists, ...hybridKeyboardists];

    const weekDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    const masses = {
      Monday: ["5:30am", "7am"],
      Tuesday: ["5:30am", "7am"],
      Wednesday: ["5:30am", "7am"],
      Thursday: ["5:30am", "7am"],
      Friday: ["5:30am", "7am", "10am", "5:30pm"],
      Saturday: ["5:30am", "7am"],
      Sunday: ["5:30am", "7am", "10am", "5pm"]
    };

    const keyboardMasses = {
      Friday: ["7am", "10am", "5:30pm"],
      Saturday: ["7am"],
      Sunday: ["7am", "10am", "5pm"]
    };

    const fr10Exclusions = ["atul", "aibel", "angel", "sneha", "soyal", "christy", "dona", "abraham jr", "abraham sn", "jemcy"];
    const only530 = ["seby", "jincy", "biji"];

    let assignmentLog = [];
    let hybridWeeklyCount = { sebastian: 0, shaji: 0 };
    let dailyAssignments = {};

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function isKeyboardMass(day, time) {
      return keyboardMasses[day]?.includes(time);
    }

    function getRandomRatio(day, time) {
      if (time === "5:30am") return [1, 1];
      const options = [[1, 1], [1, 2], [2, 2]];
      return options[Math.floor(Math.random() * options.length)];
    }

    function getAvailable(arr, day, time, limitOnce = true) {
      return arr.filter(name => {
        if (limitOnce && dailyAssignments[day]?.includes(name)) return false;
        if (time !== "5:30am" && only530.includes(name)) return false;
        if (day === "Friday" && time === "10am" && fr10Exclusions.includes(name)) return false;
        return true;
      });
    }

    function assignMass(day, time, assigned) {
      dailyAssignments[day] = dailyAssignments[day] || [];
      const isKeyMass = isKeyboardMass(day, time);
      const [mCount, fCount] = getRandomRatio(day, time);
      const availableMales = getAvailable(maleSingers, day, time);
      const availableFemales = getAvailable(femaleSingers, day, time);

      let males = shuffle(availableMales).slice(0, mCount);
      let females = shuffle(availableFemales).slice(0, fCount);

      males.forEach(m => dailyAssignments[day].push(m));
      females.forEach(f => dailyAssignments[day].push(f));

      let kb = null;
      if (isKeyMass) {
        const keyList = getAvailable([...keyboardists, ...hybridKeyboardists], day, time, false);
        const preferred = shuffle(keyList.filter(k => keyboardists.includes(k)));
        const hybrid = shuffle(keyList.filter(k => hybridKeyboardists.includes(k) && hybridWeeklyCount[k] < 1));
        if (preferred.length > 0) {
          kb = preferred[0];
        } else if (hybrid.length > 0) {
          kb = hybrid[0];
          hybridWeeklyCount[kb]++;
        }
        if (kb) dailyAssignments[day].push(kb);
      }

      const people = [
        `Time: ${time}`,
        ` Keyboard: ${kb || "None"}`,
        ` Males: ${males.join(", ")}`,
        ` Females: ${females.join(", ")}`
      ];
      assigned.push(people.join("\n"));
    }

    function generateTimetable() {
      const output = document.getElementById("output");
      const log = document.getElementById("log");
      let result = [];
      dailyAssignments = {};
      hybridWeeklyCount = { sebastian: 0, shaji: 0 };

      for (const day of weekDays) {
        result.push(day.toUpperCase());
        const assigned = [];
        for (const time of masses[day]) {
          assignMass(day, time, assigned);
        }
        result.push(assigned.join("\n\n"));
        result.push("\n");
      }

      const finalText = result.join("\n");
      output.value = finalText;
      const timestamp = new Date().toLocaleString();
      assignmentLog.push(`Generated at ${timestamp}`);
      log.innerHTML = assignmentLog.map(e => `<div class='log-entry'>${e}</div>`).join("");
    }

    function copyOutput() {
      const output = document.getElementById("output");
      output.select();
      document.execCommand("copy");
      alert("Copied to clipboard!");
    }
  </script>
</body>
</html>
