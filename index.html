<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choir Timetable Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f4f8; }
    h1 { text-align: center; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    table { width: 100%; margin-top: 20px; background: #fff; }
    th { background-color: #eee; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    .log-section { margin-top: 40px; }
    pre { background: #f7f7f7; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Choir Timetable Generator</h1>
  <button onclick="generateTimetable()">Generate Timetable</button>
  <table id="timetable">
    <thead>
      <tr>
        <th>Day</th>
        <th>Time</th>
        <th>Singers</th>
        <th>Keyboardist</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="log-section">
    <h2>Assignment Log</h2>
    <pre id="assignmentLog"></pre>
  </div>
  <script>
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const times = ['5:30 AM', '10:00 AM', '5:30 PM'];

    const choir = {
      male: ['Seby', 'Sebastian', 'Roy', 'Phijo', 'Shaji', 'Robert', 'Don', 'Aibel', 'Atul'],
      female: ['Anu', 'Angel', 'Jemcy', 'Sini', 'Priya', 'Dona', 'Soyal', 'Jincy', 'Biji', 'Christy', 'Sneha'],
      keyboard: ['Abraham Jr.', 'Davis', 'Sebastian', 'Shaji'],
    };

    const hybridKeyboardists = ['Sebastian', 'Shaji'];
    const hybridRotation = { Sebastian: 0, Shaji: 0 };

    const availability = {
      'Abraham Sr.': { 'Friday': ['10:00 AM', '5:30 PM'] },
    };

    const morningSpecials = ['Seby', 'Jincy', 'Biji'];
    const specialMorningCount = { 'Seby': 0, 'Jincy': 0, 'Biji': 0 };

    const assignments = [];
    const memberAssignments = {};

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function getValidSingerCombination(males, females) {
      const combinations = [];
      if (males.length >= 1 && females.length >= 1) combinations.push([1, 1]);
      if (males.length >= 1 && females.length >= 2) combinations.push([1, 2]);
      if (males.length >= 2 && females.length >= 2) combinations.push([2, 2]);
      return combinations[Math.floor(Math.random() * combinations.length)];
    }

    function isUnavailable(name, day, time) {
      return availability[name]?.[day]?.includes(time);
    }

    function selectKeyboardist(day, time) {
      const available = choir.keyboard.filter(kb => !isUnavailable(kb, day, time));
      const hybrids = hybridKeyboardists.filter(h => available.includes(h));
      const regulars = available.filter(k => !hybrids.includes(k));

      if (regulars.length) return shuffle(regulars)[0];

      hybrids.sort((a, b) => hybridRotation[a] - hybridRotation[b]);
      const selected = hybrids[0];
      hybridRotation[selected]++;
      return selected;
    }

    function selectSingers(day, time) {
      let males = shuffle([...choir.male]);
      let females = shuffle([...choir.female]);

      if (time === '5:30 AM') {
        males = shuffle(['Seby', ...choir.male.filter(m => m !== 'Seby')]);
        females = shuffle(['Jincy', 'Biji', ...choir.female.filter(f => !['Jincy', 'Biji'].includes(f))]);
      }

      const [mCount, fCount] = getValidSingerCombination(males, females);
      const selectedMales = males.slice(0, mCount);
      const selectedFemales = females.slice(0, fCount);

      const singers = [...selectedMales, ...selectedFemales];

      if (time === '5:30 AM') {
        singers.forEach(s => { if (morningSpecials.includes(s)) specialMorningCount[s]++; });
      }

      return singers;
    }

    function generateTimetable() {
      const tbody = document.querySelector('#timetable tbody');
      const log = document.getElementById('assignmentLog');
      tbody.innerHTML = '';
      log.textContent = '';

      assignments.length = 0;
      Object.keys(memberAssignments).forEach(m => memberAssignments[m] = []);

      for (const day of days) {
        for (const time of times) {
          const singers = selectSingers(day, time);
          const keyboardist = selectKeyboardist(day, time);

          const row = document.createElement('tr');
          row.innerHTML = `<td>${day}</td><td>${time}</td><td>${singers.join(', ')}</td><td>${keyboardist}</td>`;
          tbody.appendChild(row);

          const record = { day, time, singers, keyboardist };
          assignments.push(record);

          [...singers, keyboardist].forEach(name => {
            if (!memberAssignments[name]) memberAssignments[name] = [];
            memberAssignments[name].push(`${day} ${time}`);
          });
        }
      }

      let logText = '';
      for (const [member, assigned] of Object.entries(memberAssignments)) {
        logText += `${member}: ${assigned.join(', ')}\n`;
      }
      log.textContent = logText;
    }
  </script>
</body>
</html>
